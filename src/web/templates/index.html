{% extends "base.html" %}

{% block page_title %}Dashboard{% endblock %}

{% block title %}Dashboard - Geoscout Pro{% endblock %}

{% block head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- API Key Warning -->
    {% if not has_api_key %}
    <div class="bg-accent-warning/20 border border-accent-warning rounded-lg p-4">
        <div class="flex items-center gap-3">
            <svg class="w-6 h-6 text-accent-warning flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div>
                <p class="font-semibold text-accent-warning">API Key nao configurada</p>
                <p class="text-sm text-accent-warning/80">Configure GOOGLE_PLACES_API_KEY no ficheiro .env</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Total Leads Card -->
        <a href="/leads" class="bg-dark-card rounded-xl border border-dark-border p-6 hover:border-accent-primary transition group">
            <div class="flex justify-between items-start">
                <div>
                    <div class="text-dark-text-secondary text-sm mb-2">Total Leads</div>
                    <div class="text-3xl font-bold text-accent-primary">{{ stats.total }}</div>
                </div>
                <div class="w-12 h-12 bg-accent-primary/10 rounded-lg flex items-center justify-center group-hover:bg-accent-primary/20 transition">
                    <svg class="w-6 h-6 text-accent-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                </div>
            </div>
        </a>

        <!-- Score Medio Card -->
        <a href="/leads?min_score=50" class="bg-dark-card rounded-xl border border-dark-border p-6 hover:border-accent-success transition group">
            <div class="flex justify-between items-start">
                <div>
                    <div class="text-dark-text-secondary text-sm mb-2">Score Medio</div>
                    <div class="text-3xl font-bold text-accent-success">{{ stats.avg_score }}</div>
                </div>
                <div class="w-12 h-12 bg-accent-success/10 rounded-lg flex items-center justify-center group-hover:bg-accent-success/20 transition">
                    <svg class="w-6 h-6 text-accent-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
            </div>
        </a>

        <!-- Sem Website Card -->
        <a href="/leads?has_website=no" class="bg-dark-card rounded-xl border border-dark-border p-6 hover:border-accent-warning transition group">
            <div class="flex justify-between items-start">
                <div>
                    <div class="text-dark-text-secondary text-sm mb-2">Sem Website</div>
                    <div class="text-3xl font-bold text-accent-warning">{{ stats.without_website }}</div>
                </div>
                <div class="w-12 h-12 bg-accent-warning/10 rounded-lg flex items-center justify-center group-hover:bg-accent-warning/20 transition">
                    <svg class="w-6 h-6 text-accent-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                    </svg>
                </div>
            </div>
        </a>

        <!-- Novos esta Semana Card -->
        <a href="/leads?this_week=yes" class="bg-dark-card rounded-xl border border-dark-border p-6 hover:border-accent-secondary transition group">
            <div class="flex justify-between items-start">
                <div>
                    <div class="text-dark-text-secondary text-sm mb-2">Novos esta Semana</div>
                    <div class="text-3xl font-bold text-accent-secondary">{{ stats.new_this_week }}</div>
                </div>
                <div class="w-12 h-12 bg-accent-secondary/10 rounded-lg flex items-center justify-center group-hover:bg-accent-secondary/20 transition">
                    <svg class="w-6 h-6 text-accent-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            </div>
        </a>
    </div>

    <!-- Charts and Recent Searches Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Donut Chart - Leads por Status -->
        <div class="bg-dark-card rounded-xl border border-dark-border p-6">
            <h3 class="text-lg font-semibold text-dark-text-primary mb-6">Leads por Status</h3>
            <div class="flex items-center justify-center gap-8 flex-wrap lg:flex-nowrap">
                <!-- Chart Canvas -->
                <div class="relative flex-shrink-0">
                    <canvas id="statusDonutChart" width="180" height="180"></canvas>
                </div>
                <!-- Legend -->
                <div class="space-y-3 flex-1 min-w-[200px]">
                    {% set status_colors = {
                        'new': '#3b82f6',
                        'contacted': '#f59e0b',
                        'qualified': '#8b5cf6',
                        'converted': '#10b981',
                        'rejected': '#6b7280'
                    } %}
                    {% for status, count in stats.by_status.items() %}
                    <a href="/leads?status={{ status }}" class="flex items-center justify-between p-2 rounded-lg hover:bg-dark-card-hover transition group">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: {{ status_colors.get(status, '#6b7280') }}"></div>
                            <span class="text-dark-text-primary capitalize group-hover:text-accent-primary transition">{{ status }}</span>
                        </div>
                        <span class="text-dark-text-secondary font-semibold">{{ count }}</span>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Recent Searches -->
        <div class="bg-dark-card rounded-xl border border-dark-border p-6">
            <h3 class="text-lg font-semibold text-dark-text-primary mb-6">Pesquisas Recentes</h3>
            {% if recent_searches %}
            <div class="space-y-3">
                {% for search in recent_searches %}
                <div class="flex justify-between items-center py-3 border-b border-dark-border last:border-0 hover:bg-dark-card-hover px-2 rounded-lg transition">
                    <div class="flex-1 min-w-0">
                        <div class="font-medium text-dark-text-primary truncate">
                            {{ search.query_params.query if search.query_params else 'N/A' }}
                        </div>
                        <div class="text-sm text-dark-text-secondary mt-1">
                            {{ search.results_count }} resultados
                        </div>
                    </div>
                    <div class="text-sm text-dark-text-muted ml-4 flex-shrink-0">
                        {{ search.executed_at.strftime('%d/%m %H:%M') }}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="flex flex-col items-center justify-center py-12">
                <svg class="w-16 h-16 text-dark-text-muted mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <p class="text-dark-text-secondary">Nenhuma pesquisa realizada ainda</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-dark-card rounded-xl border border-dark-border p-6">
        <h3 class="text-lg font-semibold text-dark-text-primary mb-6">Acoes Rapidas</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Nova Pesquisa -->
            <a href="/search" class="bg-dark-surface border-2 border-accent-primary/20 rounded-lg p-6 hover:border-accent-primary hover:bg-dark-card-hover transition group">
                <div class="flex flex-col items-center text-center gap-3">
                    <div class="w-12 h-12 bg-accent-primary/10 rounded-lg flex items-center justify-center group-hover:bg-accent-primary/20 transition">
                        <svg class="w-6 h-6 text-accent-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </div>
                    <span class="font-semibold text-dark-text-primary group-hover:text-accent-primary transition">Nova Pesquisa</span>
                </div>
            </a>

            <!-- Leads Quentes -->
            <a href="/leads?min_score=50" class="bg-dark-surface border-2 border-accent-success/20 rounded-lg p-6 hover:border-accent-success hover:bg-dark-card-hover transition group">
                <div class="flex flex-col items-center text-center gap-3">
                    <div class="w-12 h-12 bg-accent-success/10 rounded-lg flex items-center justify-center group-hover:bg-accent-success/20 transition">
                        <svg class="w-6 h-6 text-accent-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"/>
                        </svg>
                    </div>
                    <span class="font-semibold text-dark-text-primary group-hover:text-accent-success transition">Leads Quentes</span>
                </div>
            </a>

            <!-- Sem Website -->
            <a href="/leads?has_website=no" class="bg-dark-surface border-2 border-accent-warning/20 rounded-lg p-6 hover:border-accent-warning hover:bg-dark-card-hover transition group">
                <div class="flex flex-col items-center text-center gap-3">
                    <div class="w-12 h-12 bg-accent-warning/10 rounded-lg flex items-center justify-center group-hover:bg-accent-warning/20 transition">
                        <svg class="w-6 h-6 text-accent-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </div>
                    <span class="font-semibold text-dark-text-primary group-hover:text-accent-warning transition">Sem Website</span>
                </div>
            </a>

            <!-- Exportar -->
            <a href="/export" class="bg-dark-surface border-2 border-accent-secondary/20 rounded-lg p-6 hover:border-accent-secondary hover:bg-dark-card-hover transition group">
                <div class="flex flex-col items-center text-center gap-3">
                    <div class="w-12 h-12 bg-accent-secondary/10 rounded-lg flex items-center justify-center group-hover:bg-accent-secondary/20 transition">
                        <svg class="w-6 h-6 text-accent-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                    </div>
                    <span class="font-semibold text-dark-text-primary group-hover:text-accent-secondary transition">Exportar</span>
                </div>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Status Donut Chart
const statusCtx = document.getElementById('statusDonutChart');
if (statusCtx) {
    const statusData = {
        labels: [
            {% for status in stats.by_status.keys() %}
            '{{ status|capitalize }}'{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            data: [
                {% for count in stats.by_status.values() %}
                {{ count }}{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            backgroundColor: [
                '#3b82f6',  // blue - new
                '#f59e0b',  // amber - contacted
                '#8b5cf6',  // purple - qualified
                '#10b981',  // emerald - converted
                '#6b7280'   // gray - rejected
            ],
            borderColor: '#1f2937',
            borderWidth: 2,
            hoverOffset: 8
        }]
    };

    const statusConfig = {
        type: 'doughnut',
        data: statusData,
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: '#1f2937',
                    titleColor: '#f9fafb',
                    bodyColor: '#f9fafb',
                    borderColor: '#374151',
                    borderWidth: 1,
                    padding: 12,
                    boxPadding: 6,
                    usePointStyle: true,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return label + ': ' + value + ' (' + percentage + '%)';
                        }
                    }
                }
            },
            cutout: '65%',
            animation: {
                animateRotate: true,
                animateScale: true
            }
        }
    };

    new Chart(statusCtx, statusConfig);
}
</script>
{% endblock %}
