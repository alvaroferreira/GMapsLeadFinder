{% extends "base.html" %}

{% block title %}Leads - Lead Finder{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-800">Leads ({{ total }})</h1>
    </div>

    <!-- Filters -->
    <form method="get" class="bg-white rounded-lg shadow p-4">
        <div class="flex flex-wrap gap-4 items-end">
            <div>
                <label class="block text-gray-700 text-sm mb-1">Status</label>
                <select name="status" class="px-3 py-2 border rounded">
                    <option value="">Todos</option>
                    {% for s in statuses %}
                    <option value="{{ s }}" {% if current_status == s %}selected{% endif %}>{{ s|capitalize }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-gray-700 text-sm mb-1">Score Minimo</label>
                <input type="number" name="min_score" value="{{ current_min_score or '' }}"
                       placeholder="Ex: 50" class="px-3 py-2 border rounded w-24">
            </div>
            <div>
                <label class="block text-gray-700 text-sm mb-1">Website</label>
                <select name="has_website" class="px-3 py-2 border rounded">
                    <option value="">Todos</option>
                    <option value="yes" {% if current_has_website == 'yes' %}selected{% endif %}>Com</option>
                    <option value="no" {% if current_has_website == 'no' %}selected{% endif %}>Sem</option>
                </select>
            </div>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                Filtrar
            </button>
            <a href="/leads" class="text-gray-600 hover:text-gray-800 px-4 py-2">Limpar</a>
        </div>
    </form>

    <!-- Notion Sync Bulk Action (if Notion is active) -->
    {% if notion_active %}
    <div class="bg-white rounded-lg shadow p-4" id="notion-bulk-actions">
        <div class="flex items-center gap-4">
            <span class="text-gray-700 font-medium">Notion:</span>
            <button type="button" onclick="syncSelectedToNotion()" class="bg-black text-white px-4 py-2 rounded hover:bg-gray-800">
                Sync Selecionados
            </button>
            <span id="notion-bulk-result" class="text-sm"></span>
        </div>
    </div>
    {% endif %}

    <!-- Leads Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    {% if notion_active %}
                    <th class="px-2 py-3 text-left text-gray-600">
                        <input type="checkbox" id="select-all" onclick="toggleSelectAll()" class="rounded">
                    </th>
                    {% endif %}
                    <th class="px-4 py-3 text-left text-gray-600">Nome</th>
                    <th class="px-4 py-3 text-left text-gray-600">Score</th>
                    <th class="px-4 py-3 text-left text-gray-600">Rating</th>
                    <th class="px-4 py-3 text-left text-gray-600">Reviews</th>
                    <th class="px-4 py-3 text-left text-gray-600">Website</th>
                    <th class="px-4 py-3 text-left text-gray-600">Status</th>
                    {% if notion_active %}
                    <th class="px-4 py-3 text-left text-gray-600">Notion</th>
                    {% endif %}
                    <th class="px-4 py-3 text-left text-gray-600">Acoes</th>
                </tr>
            </thead>
            <tbody class="divide-y">
                {% for b in businesses %}
                <tr class="hover:bg-gray-50">
                    {% if notion_active %}
                    <td class="px-2 py-3">
                        <input type="checkbox" class="lead-checkbox rounded" value="{{ b['id'] }}">
                    </td>
                    {% endif %}
                    <td class="px-4 py-3">
                        <div class="font-medium text-gray-800">{{ b['name'][:35] if b['name'] else '-' }}{% if b['name'] and b['name']|length > 35 %}...{% endif %}</div>
                        <div class="text-gray-500 text-sm">{{ b['formatted_address'][:40] if b['formatted_address'] else '-' }}{% if b['formatted_address'] and b['formatted_address']|length > 40 %}...{% endif %}</div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-sm font-medium
                            {% if b['lead_score'] >= 50 %}bg-green-100 text-green-800
                            {% elif b['lead_score'] >= 30 %}bg-yellow-100 text-yellow-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ b['lead_score'] }}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        {% if b['rating'] %}
                        <span class="text-yellow-500">★</span> {{ "%.1f"|format(b['rating']) }}
                        {% else %}-{% endif %}
                    </td>
                    <td class="px-4 py-3">{{ b['review_count'] or 0 }}</td>
                    <td class="px-4 py-3">
                        {% if b['has_website'] %}
                        <span class="text-green-600">✓</span>
                        {% else %}
                        <span class="text-red-500">✗</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-sm
                            {% if b['lead_status'] == 'new' %}bg-blue-100 text-blue-800
                            {% elif b['lead_status'] == 'contacted' %}bg-yellow-100 text-yellow-800
                            {% elif b['lead_status'] == 'qualified' %}bg-purple-100 text-purple-800
                            {% elif b['lead_status'] == 'converted' %}bg-green-100 text-green-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ b['lead_status'] }}
                        </span>
                    </td>
                    {% if notion_active %}
                    <td class="px-4 py-3">
                        {% if b['notion_synced_at'] %}
                        <span class="text-green-600 text-sm" title="Sincronizado em {{ b['notion_synced_at'].strftime('%d/%m %H:%M') }}">✓</span>
                        {% else %}
                        <span class="text-gray-400 text-sm">-</span>
                        {% endif %}
                    </td>
                    {% endif %}
                    <td class="px-4 py-3">
                        <a href="/leads/{{ b['id'] }}" class="text-blue-600 hover:text-blue-800">Ver</a>
                        {% if b['google_maps_url'] %}
                        <a href="{{ b['google_maps_url'] }}" target="_blank" class="text-gray-600 hover:text-gray-800 ml-2">Maps</a>
                        {% endif %}
                        {% if notion_active %}
                        <button hx-post="/notion/sync/{{ b['id'] }}"
                                hx-target="#notion-result-{{ loop.index }}"
                                class="text-gray-600 hover:text-gray-800 ml-2 text-sm">Sync</button>
                        <span id="notion-result-{{ loop.index }}" class="ml-1"></span>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="{% if notion_active %}9{% else %}7{% endif %}" class="px-4 py-8 text-center text-gray-500">
                        Nenhum lead encontrado com os filtros selecionados
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="flex justify-center gap-2">
        {% if page > 1 %}
        <a href="?page={{ page - 1 }}{% if current_status %}&status={{ current_status }}{% endif %}{% if current_min_score %}&min_score={{ current_min_score }}{% endif %}{% if current_has_website %}&has_website={{ current_has_website }}{% endif %}"
           class="px-4 py-2 bg-white border rounded hover:bg-gray-50">Anterior</a>
        {% endif %}

        <span class="px-4 py-2 text-gray-600">Pagina {{ page }} de {{ total_pages }}</span>

        {% if page < total_pages %}
        <a href="?page={{ page + 1 }}{% if current_status %}&status={{ current_status }}{% endif %}{% if current_min_score %}&min_score={{ current_min_score }}{% endif %}{% if current_has_website %}&has_website={{ current_has_website }}{% endif %}"
           class="px-4 py-2 bg-white border rounded hover:bg-gray-50">Proxima</a>
        {% endif %}
    </div>
    {% endif %}
</div>

{% if notion_active %}
<script>
function toggleSelectAll() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.lead-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
}

async function syncSelectedToNotion() {
    const checkboxes = document.querySelectorAll('.lead-checkbox:checked');
    const ids = Array.from(checkboxes).map(cb => cb.value);

    if (ids.length === 0) {
        alert('Seleciona pelo menos um lead');
        return;
    }

    const resultSpan = document.getElementById('notion-bulk-result');
    resultSpan.innerHTML = '<span class="text-gray-600">A sincronizar...</span>';

    try {
        const response = await fetch('/notion/sync-batch', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `place_ids=${ids.join(',')}`
        });

        const html = await response.text();
        resultSpan.innerHTML = html;

        // Reload page after 2 seconds to show updated sync status
        setTimeout(() => window.location.reload(), 2000);
    } catch (error) {
        resultSpan.innerHTML = `<span class="text-red-600">Erro: ${error.message}</span>`;
    }
}
</script>
{% endif %}
{% endblock %}
