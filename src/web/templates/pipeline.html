{% extends "base.html" %}

{% block page_title %}Pipeline{% endblock %}
{% block title %}Pipeline - Geoscout Pro{% endblock %}

{% block content %}
<div class="h-[calc(100vh-8rem)] flex flex-col">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-dark-text-primary">Pipeline</h1>
            <p class="text-dark-text-secondary">Arrasta os cards para mudar o status</p>
        </div>
        <div class="text-sm text-dark-text-muted">
            Total: <span class="font-semibold text-dark-text-primary">{{ total_leads }}</span> leads
        </div>
    </div>

    <!-- Kanban Board -->
    <div class="flex-1 flex gap-4 overflow-x-auto pb-4" role="region" aria-label="Kanban board de pipeline de leads">
        {% for status in statuses %}
        <div class="kanban-column flex-shrink-0 w-72 bg-dark-surface rounded-xl border border-dark-border flex flex-col max-h-full" role="region" aria-label="Coluna {{ status.label }}">
            <!-- Column Header -->
            <div class="p-4 border-b border-dark-border flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-{{ status.color }}" aria-hidden="true"></span>
                    <h2 class="font-semibold text-dark-text-primary">{{ status.label }}</h2>
                </div>
                <span class="px-2 py-1 bg-dark-card rounded-full text-xs text-dark-text-muted" aria-label="{{ leads_by_status[status.key]|length }} leads">
                    {{ leads_by_status[status.key]|length }}
                </span>
            </div>

            <!-- Cards Container (scrollable) -->
            <div class="flex-1 p-3 space-y-3 overflow-y-auto"
                 data-status="{{ status.key }}"
                 ondrop="dropCard(event)"
                 ondragover="allowDrop(event)"
                 ondragenter="dragEnter(event)"
                 ondragleave="dragLeave(event)"
                 role="list"
                 aria-label="Leads no status {{ status.label }}">
                {% for lead in leads_by_status[status.key] %}
                <div class="kanban-card bg-dark-card p-4 rounded-lg border border-dark-border cursor-grab hover:border-accent-primary hover:shadow-dark transition"
                     draggable="true"
                     data-id="{{ lead.id }}"
                     ondragstart="dragStart(event)"
                     ondragend="dragEnd(event)"
                     onclick="openLeadDrawerFromPipeline('{{ lead.id }}', event)"
                     role="listitem"
                     tabindex="0"
                     aria-label="{{ lead.name }}, rating {{ lead.rating or 'sem rating' }}, score {{ lead.lead_score }}"
                     onkeydown="if(event.key === 'Enter' || event.key === ' ') { event.preventDefault(); openLeadDrawerFromPipeline('{{ lead.id }}', event); }">
                    <!-- Nome truncado -->
                    <div class="font-medium text-sm text-dark-text-primary truncate mb-1">{{ lead.name }}</div>
                    <!-- Endereco truncado -->
                    <div class="text-xs text-dark-text-muted truncate mb-3">{{ lead.formatted_address }}</div>
                    <!-- Footer: Rating + Score -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-1 text-xs">
                            <span class="text-yellow-400">â˜…</span>
                            <span class="text-dark-text-secondary">{{ lead.rating or '-' }}</span>
                        </div>
                        <div class="px-2 py-0.5 rounded-full text-xs font-medium {% if lead.lead_score >= 70 %}bg-accent-success/20 text-accent-success{% elif lead.lead_score >= 40 %}bg-accent-warning/20 text-accent-warning{% else %}bg-dark-surface text-dark-text-muted{% endif %}">
                            {{ lead.lead_score }}
                        </div>
                    </div>
                </div>
                {% endfor %}

                {% if not leads_by_status[status.key] %}
                <div class="text-center py-8 text-dark-text-muted text-sm">
                    Nenhum lead
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
let draggedElement = null;
let isDragging = false;

function dragStart(e) {
    isDragging = true;
    draggedElement = e.target.closest('.kanban-card');
    e.target.classList.add('opacity-50');
    e.dataTransfer.setData("text/plain", draggedElement.dataset.id);
    e.dataTransfer.effectAllowed = "move";
}

function dragEnd(e) {
    e.target.classList.remove('opacity-50');
    document.querySelectorAll('.kanban-column > div:last-child').forEach(col => {
        col.classList.remove('bg-accent-primary/10');
    });
    // Reset dragging flag after a small delay (to allow click event to check)
    setTimeout(() => { isDragging = false; }, 100);
}

// Open lead drawer when clicking on card (not during drag)
function openLeadDrawerFromPipeline(leadId, event) {
    // Ignore clicks during drag operations
    if (isDragging) return;

    // Fetch drawer content via HTMX
    htmx.ajax('GET', `/leads/${leadId}/drawer`, {target: '#lead-drawer-content'});
}

function allowDrop(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";
}

function dragEnter(e) {
    e.preventDefault();
    e.currentTarget.classList.add('bg-accent-primary/10');
}

function dragLeave(e) {
    e.currentTarget.classList.remove('bg-accent-primary/10');
}

function dropCard(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('bg-accent-primary/10');

    const leadId = e.dataTransfer.getData("text/plain");
    const newStatus = e.currentTarget.dataset.status;

    // Move card visualmente
    if (draggedElement) {
        e.currentTarget.appendChild(draggedElement);
    }

    // Update via API
    fetch(`/leads/${leadId}/status`, {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `status=${newStatus}`
    }).then(response => {
        if (!response.ok) {
            location.reload(); // Refresh se falhar
        }
    });
}
</script>
{% endblock %}
