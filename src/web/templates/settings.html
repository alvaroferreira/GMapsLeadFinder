{% extends "base.html" %}

{% block page_title %}Settings{% endblock %}

{% block title %}Settings - Lead Finder{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-dark-text-primary">Configuracoes</h1>
    </div>

    <!-- Notion Integration -->
    <div class="bg-dark-card rounded-xl border border-dark-border shadow overflow-hidden">
        <div class="px-6 py-4 bg-dark-surface border-b border-dark-border flex items-center justify-between">
            <div class="flex items-center gap-3">
                <svg class="w-8 h-8" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6.017 4.313l55.333 -4.087c6.797 -0.583 8.543 -0.19 12.817 2.917l17.663 12.443c2.913 2.14 3.883 2.723 3.883 5.053v68.243c0 4.277 -1.553 6.807 -6.99 7.193L24.467 99.967c-4.08 0.193 -6.023 -0.39 -8.16 -3.113L3.3 79.94c-2.333 -3.113 -3.3 -5.443 -3.3 -8.167V11.113c0 -3.497 1.553 -6.413 6.017 -6.8z" fill="#fff"/>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M61.35 0.227l-55.333 4.087C1.553 4.7 0 7.617 0 11.113v60.66c0 2.723 0.967 5.053 3.3 8.167l13.007 16.913c2.137 2.723 4.08 3.307 8.16 3.113l64.257 -3.89c5.433 -0.387 6.99 -2.917 6.99 -7.193V20.64c0 -2.21 -0.873 -2.847 -3.443 -4.733L74.167 3.143c-4.273 -3.107 -6.02 -3.5 -12.817 -2.917zM25.92 19.523c-5.247 0.353 -6.437 0.433 -9.417 -1.99L8.927 11.507c-0.77 -0.78 -0.383 -1.753 1.557 -1.947l53.193 -3.887c4.467 -0.39 6.793 1.167 8.54 2.527l9.123 6.61c0.39 0.197 1.36 1.36 0.193 1.36l-54.933 3.307 -0.68 0.047zM19.803 88.3V30.367c0 -2.53 0.777 -3.697 3.103 -3.893L86 22.78c2.14 -0.193 3.107 1.167 3.107 3.693v57.547c0 2.53 -0.39 4.67 -3.883 4.863l-60.377 3.5c-3.493 0.193 -5.043 -0.97 -5.043 -4.083zm59.6 -54.827c0.387 1.75 0 3.5 -1.75 3.7l-2.91 0.577v42.773c-2.527 1.36 -4.853 2.137 -6.797 2.137 -3.107 0 -3.883 -0.973 -6.21 -3.887l-19.03 -29.94v28.967l6.02 1.363s0 3.5 -4.857 3.5l-13.39 0.777c-0.39 -0.78 0 -2.723 1.357 -3.11l3.497 -0.97v-38.3L30.48 40.667c-0.39 -1.75 0.58 -4.277 3.3 -4.473l14.367 -0.967 19.8 30.327v-26.83l-5.047 -0.58c-0.39 -2.143 1.163 -3.7 3.103 -3.89l13.4 -0.78z" fill="#000"/>
                </svg>
                <div>
                    <h2 class="text-lg font-semibold text-dark-text-primary">Notion CRM</h2>
                    <p class="text-sm text-dark-text-secondary">Sincroniza leads com uma database Notion</p>
                </div>
            </div>
            {% if notion_config and notion_config.is_active %}
            <span class="px-3 py-1 bg-accent-success/10 text-accent-success border border-accent-success/20 rounded-full text-sm font-medium">Conectado</span>
            {% else %}
            <span class="px-3 py-1 bg-accent-danger/10 text-accent-danger border border-accent-danger/20 rounded-full text-sm font-medium">Desconectado</span>
            {% endif %}
        </div>

        <div class="p-6">
            {% if notion_config and notion_config.is_active %}
            <!-- Connected State -->
            <div class="space-y-4">
                <div class="bg-accent-success/10 border border-accent-success/20 rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-accent-success mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        <div>
                            <h3 class="font-medium text-accent-success">Integracao Ativa</h3>
                            <p class="text-sm text-dark-text-secondary mt-1">
                                Workspace: <strong class="text-dark-text-primary">{{ notion_config.workspace_name or 'N/A' }}</strong>
                            </p>
                            {% if notion_config.last_sync_at %}
                            <p class="text-sm text-dark-text-secondary">
                                Ultima sync: {{ notion_config.last_sync_at.strftime('%d/%m/%Y %H:%M') }}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-dark-surface rounded-lg p-4 text-center border border-dark-border">
                        <div class="text-2xl font-bold text-accent-primary">{{ sync_stats.total }}</div>
                        <div class="text-sm text-dark-text-muted">Total Leads</div>
                    </div>
                    <div class="bg-dark-surface rounded-lg p-4 text-center border border-dark-border">
                        <div class="text-2xl font-bold text-accent-success">{{ sync_stats.synced }}</div>
                        <div class="text-sm text-dark-text-muted">Sincronizados</div>
                    </div>
                    <div class="bg-dark-surface rounded-lg p-4 text-center border border-dark-border">
                        <div class="text-2xl font-bold text-accent-warning">{{ sync_stats.not_synced }}</div>
                        <div class="text-sm text-dark-text-muted">Por Sincronizar</div>
                    </div>
                </div>

                <div class="flex gap-2 pt-4 border-t border-dark-border">
                    <form method="post" action="/settings/notion/disconnect" class="inline"
                          onsubmit="return confirm('Desconectar do Notion? Os leads sincronizados permanecerao no Notion.')">
                        <button type="submit" class="px-4 py-2 bg-accent-danger hover:bg-accent-danger/80 text-white rounded-lg transition-colors">
                            Desconectar
                        </button>
                    </form>
                </div>
            </div>

            {% else %}
            <!-- Disconnected State -->
            <div class="space-y-6">
                <div class="bg-accent-primary/10 border border-accent-primary/20 rounded-lg p-4">
                    <h3 class="font-medium text-accent-primary">Como configurar:</h3>
                    <ol class="text-sm text-dark-text-secondary mt-2 space-y-1 list-decimal list-inside">
                        <li>Vai a <a href="https://www.notion.so/my-integrations" target="_blank" class="underline text-accent-primary hover:text-accent-primary/80">notion.so/my-integrations</a></li>
                        <li>Cria uma nova "Internal Integration"</li>
                        <li>Copia o "Internal Integration Token"</li>
                        <li>No Notion, partilha a database com a integracao</li>
                    </ol>
                </div>

                <form id="notion-connect-form" class="space-y-4">
                    <div>
                        <label for="notion-api-key" class="block text-dark-text-secondary font-medium mb-2">API Key (Internal Integration Token)</label>
                        <input type="password" name="api_key" id="notion-api-key" required
                               placeholder="secret_xxxxxxxxxxxxxxxxxxxx"
                               aria-label="Notion API Key"
                               class="w-full px-4 py-2 bg-dark-surface border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-primary focus:border-transparent transition placeholder:text-dark-text-muted">
                    </div>

                    <button type="button" onclick="testNotionConnection()"
                            class="px-4 py-2 bg-accent-primary hover:bg-accent-primary/80 text-white rounded-lg transition-colors">
                        Testar Conexao
                    </button>

                    <div id="notion-test-result" class="hidden"></div>
                </form>

                <!-- Database Selection (hidden initially) -->
                <div id="notion-database-section" class="hidden space-y-4 pt-4 border-t border-dark-border">
                    <div>
                        <label for="notion-database-select" class="block text-dark-text-secondary font-medium mb-2">Seleciona a Database</label>
                        <select name="database_id" id="notion-database-select"
                                aria-label="Selecionar Notion Database"
                                class="w-full px-4 py-2 bg-dark-surface border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-primary focus:border-transparent transition">
                            <option value="">Seleciona uma database...</option>
                        </select>
                        <p class="text-sm text-dark-text-muted mt-1">
                            Certifica-te que partilhaste a database com a integracao no Notion.
                        </p>
                    </div>

                    <button type="button" onclick="connectNotion()"
                            class="px-4 py-2 bg-accent-success hover:bg-accent-success/80 text-white rounded-lg transition-colors">
                        Conectar
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Google Maps API Key -->
    <div class="bg-dark-card rounded-xl border border-dark-border shadow overflow-hidden">
        <div class="px-6 py-4 bg-dark-surface border-b border-dark-border flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                    </svg>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-dark-text-primary">Google Maps API</h2>
                    <p class="text-sm text-dark-text-secondary">Para pesquisas de negocios e visualizacao no mapa</p>
                </div>
            </div>
            {% if google_maps_configured %}
            <span class="px-3 py-1 bg-accent-success/10 text-accent-success border border-accent-success/20 rounded-full text-sm font-medium">Configurado</span>
            {% else %}
            <span class="px-3 py-1 bg-accent-warning/10 text-accent-warning border border-accent-warning/20 rounded-full text-sm font-medium">Nao Configurado</span>
            {% endif %}
        </div>

        <div class="p-6 space-y-4">
            <div class="bg-accent-primary/10 border border-accent-primary/20 rounded-lg p-4">
                <h3 class="font-medium text-accent-primary">Como obter:</h3>
                <ol class="text-sm text-dark-text-secondary mt-2 space-y-1 list-decimal list-inside">
                    <li>Vai a <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="underline text-accent-primary hover:text-accent-primary/80">Google Cloud Console</a></li>
                    <li>Cria um projeto ou seleciona um existente</li>
                    <li>Ativa a "Places API" e "Maps JavaScript API"</li>
                    <li>Cria uma API Key em "Credentials"</li>
                </ol>
            </div>

            <form id="gmaps-form" class="space-y-4">
                <div>
                    <label for="google-maps-api-key" class="block text-dark-text-secondary font-medium mb-2">Google Maps API Key</label>
                    <div class="flex gap-2">
                        <input type="password" name="google_maps_api_key" id="google-maps-api-key"
                               value="{{ google_maps_key_masked or '' }}"
                               placeholder="AIzaSy..."
                               aria-label="Google Maps API Key"
                               class="flex-1 px-4 py-2 bg-dark-surface border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-primary focus:border-transparent transition placeholder:text-dark-text-muted">
                        <button type="button" onclick="toggleApiKeyVisibility('google-maps-api-key')"
                                aria-label="Mostrar/Ocultar API Key"
                                class="px-3 py-2 bg-dark-surface border border-dark-border rounded-lg hover:bg-dark-card-hover transition">
                            <svg class="w-5 h-5 text-dark-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-dark-text-muted mt-1">A key e guardada no ficheiro .env</p>
                </div>

                <button type="button" onclick="saveGoogleMapsKey()"
                        class="px-4 py-2 bg-accent-primary hover:bg-accent-primary/80 text-white rounded-lg transition-colors">
                    Guardar
                </button>
                <span id="gmaps-save-result" class="ml-2 text-sm"></span>
            </form>
        </div>
    </div>

    <!-- AI Chatbots API Keys -->
    <div class="bg-dark-card rounded-xl border border-dark-border shadow overflow-hidden">
        <div class="px-6 py-4 bg-dark-surface border-b border-dark-border">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-dark-text-primary">AI Assistants</h2>
                    <p class="text-sm text-dark-text-secondary">Para geracao de emails personalizados e analise de leads</p>
                </div>
            </div>
        </div>

        <div class="p-6 space-y-6">
            <!-- OpenAI / ChatGPT -->
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-emerald-600 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M22.282 9.821a5.985 5.985 0 0 0-.516-4.91 6.046 6.046 0 0 0-6.51-2.9A6.065 6.065 0 0 0 4.981 4.18a5.985 5.985 0 0 0-3.998 2.9 6.046 6.046 0 0 0 .743 7.097 5.98 5.98 0 0 0 .51 4.911 6.051 6.051 0 0 0 6.515 2.9A5.985 5.985 0 0 0 13.26 24a6.056 6.056 0 0 0 5.772-4.206 5.99 5.99 0 0 0 3.997-2.9 6.056 6.056 0 0 0-.747-7.073zM13.26 22.43a4.476 4.476 0 0 1-2.876-1.04l.141-.081 4.779-2.758a.795.795 0 0 0 .392-.681v-6.737l2.02 1.168a.071.071 0 0 1 .038.052v5.583a4.504 4.504 0 0 1-4.494 4.494zM3.6 18.304a4.47 4.47 0 0 1-.535-3.014l.142.085 4.783 2.759a.771.771 0 0 0 .78 0l5.843-3.369v2.332a.08.08 0 0 1-.033.062L9.74 19.95a4.5 4.5 0 0 1-6.14-1.646zM2.34 7.896a4.485 4.485 0 0 1 2.366-1.973V11.6a.766.766 0 0 0 .388.676l5.815 3.355-2.02 1.168a.076.076 0 0 1-.071 0l-4.83-2.786A4.504 4.504 0 0 1 2.34 7.872zm16.597 3.855l-5.833-3.387L15.119 7.2a.076.076 0 0 1 .071 0l4.83 2.791a4.494 4.494 0 0 1-.676 8.105v-5.678a.79.79 0 0 0-.407-.667zm2.01-3.023l-.141-.085-4.774-2.782a.776.776 0 0 0-.785 0L9.409 9.23V6.897a.066.066 0 0 1 .028-.061l4.83-2.787a4.5 4.5 0 0 1 6.68 4.66zm-12.64 4.135l-2.02-1.164a.08.08 0 0 1-.038-.057V6.075a4.5 4.5 0 0 1 7.375-3.453l-.142.08L8.704 5.46a.795.795 0 0 0-.393.681zm1.097-2.365l2.602-1.5 2.607 1.5v2.999l-2.597 1.5-2.607-1.5z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-medium text-dark-text-primary">OpenAI (ChatGPT)</h3>
                            <p class="text-xs text-dark-text-muted">GPT-4, GPT-3.5-turbo</p>
                        </div>
                    </div>
                    {% if openai_configured %}
                    <span class="px-2 py-1 bg-accent-success/10 text-accent-success text-xs rounded-full">Ativo</span>
                    {% endif %}
                </div>
                <div class="flex gap-2">
                    <input type="password" name="openai_api_key" id="openai-api-key"
                           value="{{ openai_key_masked or '' }}"
                           placeholder="sk-..."
                           class="flex-1 px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-primary placeholder:text-dark-text-muted text-sm">
                    <button type="button" onclick="toggleApiKeyVisibility('openai-api-key')"
                            class="px-3 py-2 bg-dark-surface border border-dark-border rounded-lg hover:bg-dark-card-hover transition-colors">
                        <svg class="w-4 h-4 text-dark-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Anthropic / Claude -->
            <div class="space-y-3 pt-4 border-t border-dark-border">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-orange-500 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M17.303 4.303L12 9.606l-5.303-5.303L4.303 6.697 9.606 12l-5.303 5.303 2.394 2.394L12 14.394l5.303 5.303 2.394-2.394L14.394 12l5.303-5.303-2.394-2.394z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-medium text-dark-text-primary">Anthropic (Claude)</h3>
                            <p class="text-xs text-dark-text-muted">Claude 3.5 Sonnet, Claude 3 Opus</p>
                        </div>
                    </div>
                    {% if anthropic_configured %}
                    <span class="px-2 py-1 bg-accent-success/10 text-accent-success text-xs rounded-full">Ativo</span>
                    {% endif %}
                </div>
                <div class="flex gap-2">
                    <input type="password" name="anthropic_api_key" id="anthropic-api-key"
                           value="{{ anthropic_key_masked or '' }}"
                           placeholder="sk-ant-..."
                           class="flex-1 px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-primary placeholder:text-dark-text-muted text-sm">
                    <button type="button" onclick="toggleApiKeyVisibility('anthropic-api-key')"
                            class="px-3 py-2 bg-dark-surface border border-dark-border rounded-lg hover:bg-dark-card-hover transition-colors">
                        <svg class="w-4 h-4 text-dark-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Google / Gemini -->
            <div class="space-y-3 pt-4 border-t border-dark-border">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-medium text-dark-text-primary">Google (Gemini)</h3>
                            <p class="text-xs text-dark-text-muted">Gemini Pro, Gemini Ultra</p>
                        </div>
                    </div>
                    {% if gemini_configured %}
                    <span class="px-2 py-1 bg-accent-success/10 text-accent-success text-xs rounded-full">Ativo</span>
                    {% endif %}
                </div>
                <div class="flex gap-2">
                    <input type="password" name="gemini_api_key" id="gemini-api-key"
                           value="{{ gemini_key_masked or '' }}"
                           placeholder="AIzaSy..."
                           class="flex-1 px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-primary placeholder:text-dark-text-muted text-sm">
                    <button type="button" onclick="toggleApiKeyVisibility('gemini-api-key')"
                            class="px-3 py-2 bg-dark-surface border border-dark-border rounded-lg hover:bg-dark-card-hover transition-colors">
                        <svg class="w-4 h-4 text-dark-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Default AI Provider Selection -->
            <div class="space-y-3 pt-4 border-t border-dark-border">
                <label for="default-ai-provider" class="block text-dark-text-secondary font-medium">Provider Predefinido para Emails</label>
                <select id="default-ai-provider" name="default_ai_provider"
                        aria-label="Provider AI Predefinido"
                        class="w-full px-4 py-2 bg-dark-surface border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-primary focus:border-transparent transition">
                    <option value="">Seleciona um provider...</option>
                    <option value="openai" {% if default_ai_provider == 'openai' %}selected{% endif %}>OpenAI (ChatGPT)</option>
                    <option value="anthropic" {% if default_ai_provider == 'anthropic' %}selected{% endif %}>Anthropic (Claude)</option>
                    <option value="gemini" {% if default_ai_provider == 'gemini' %}selected{% endif %}>Google (Gemini)</option>
                </select>
            </div>

            <button type="button" onclick="saveAISettings()"
                    class="w-full px-4 py-2 bg-accent-primary hover:bg-accent-primary/80 text-white rounded-lg transition-colors">
                Guardar Configuracoes AI
            </button>
            <div id="ai-save-result" class="text-sm text-center"></div>
        </div>
    </div>

    <!-- Future Integrations Placeholder -->
    <div class="bg-dark-card rounded-xl border border-dark-border p-6">
        <h2 class="text-lg font-semibold text-dark-text-primary mb-4 pb-3 border-b border-dark-border">Outras Integracoes</h2>
        <p class="text-dark-text-muted">Mais integracoes em breve (HubSpot, Pipedrive, Mailchimp, etc.)</p>
    </div>
</div>

<script>
let currentApiKey = '';

// Toggle API key visibility
function toggleApiKeyVisibility(inputId) {
    const input = document.getElementById(inputId);
    if (input.type === 'password') {
        input.type = 'text';
    } else {
        input.type = 'password';
    }
}

// Save Google Maps API Key
async function saveGoogleMapsKey() {
    const apiKey = document.getElementById('google-maps-api-key').value;
    const resultSpan = document.getElementById('gmaps-save-result');

    if (!apiKey || apiKey.includes('*')) {
        resultSpan.className = 'ml-2 text-sm text-accent-warning';
        resultSpan.textContent = 'Introduz uma API key valida';
        return;
    }

    resultSpan.className = 'ml-2 text-sm text-dark-text-secondary';
    resultSpan.textContent = 'A guardar...';

    try {
        const response = await fetch('/settings/api-keys/google-maps', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `api_key=${encodeURIComponent(apiKey)}`
        });

        const data = await response.json();

        if (data.success) {
            resultSpan.className = 'ml-2 text-sm text-accent-success';
            resultSpan.textContent = 'Guardado com sucesso!';
            // Mask the key after saving
            document.getElementById('google-maps-api-key').value = apiKey.substring(0, 8) + '••••••••••••';
            // Refresh page after 1.5s to update status
            setTimeout(() => window.location.reload(), 1500);
        } else {
            resultSpan.className = 'ml-2 text-sm text-accent-danger';
            resultSpan.textContent = 'Erro: ' + (data.error || 'Falha ao guardar');
        }
    } catch (error) {
        resultSpan.className = 'ml-2 text-sm text-accent-danger';
        resultSpan.textContent = 'Erro: ' + error.message;
    }
}

// Save AI Settings
async function saveAISettings() {
    const openaiKey = document.getElementById('openai-api-key').value;
    const anthropicKey = document.getElementById('anthropic-api-key').value;
    const geminiKey = document.getElementById('gemini-api-key').value;
    const defaultProvider = document.getElementById('default-ai-provider').value;
    const resultDiv = document.getElementById('ai-save-result');

    resultDiv.className = 'text-sm text-center text-dark-text-secondary';
    resultDiv.textContent = 'A guardar...';

    try {
        const response = await fetch('/settings/api-keys/ai', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({
                openai_api_key: openaiKey || '',
                anthropic_api_key: anthropicKey || '',
                gemini_api_key: geminiKey || '',
                default_ai_provider: defaultProvider || ''
            })
        });

        const data = await response.json();

        if (data.success) {
            resultDiv.className = 'text-sm text-center text-accent-success';
            resultDiv.textContent = 'Configuracoes AI guardadas com sucesso!';
            // Refresh page after 1.5s to update status
            setTimeout(() => window.location.reload(), 1500);
        } else {
            resultDiv.className = 'text-sm text-center text-accent-danger';
            resultDiv.textContent = 'Erro: ' + (data.error || 'Falha ao guardar');
        }
    } catch (error) {
        resultDiv.className = 'text-sm text-center text-accent-danger';
        resultDiv.textContent = 'Erro: ' + error.message;
    }
}

async function testNotionConnection() {
    const apiKey = document.getElementById('notion-api-key').value;
    if (!apiKey) {
        alert('Introduz o API Key');
        return;
    }

    const resultDiv = document.getElementById('notion-test-result');
    resultDiv.className = 'p-4 rounded-lg bg-dark-surface border border-dark-border';
    resultDiv.innerHTML = '<span class="text-dark-text-secondary">A testar conexao...</span>';
    resultDiv.classList.remove('hidden');

    try {
        const response = await fetch('/settings/notion/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `api_key=${encodeURIComponent(apiKey)}`
        });

        const data = await response.json();

        if (data.success) {
            currentApiKey = apiKey;
            resultDiv.className = 'p-4 rounded-lg bg-accent-success/10 border border-accent-success/20';
            resultDiv.innerHTML = `
                <div class="text-accent-success">
                    <strong>Conexao bem sucedida!</strong><br>
                    <span class="text-sm text-dark-text-secondary">Workspace: ${data.workspace_name || 'N/A'}</span>
                </div>
            `;

            // Show database selection
            const dbSection = document.getElementById('notion-database-section');
            dbSection.classList.remove('hidden');

            // Load databases
            await loadNotionDatabases(apiKey);
        } else {
            resultDiv.className = 'p-4 rounded-lg bg-accent-danger/10 border border-accent-danger/20';
            resultDiv.innerHTML = `<span class="text-accent-danger">Erro: ${data.error}</span>`;
        }
    } catch (error) {
        resultDiv.className = 'p-4 rounded-lg bg-accent-danger/10 border border-accent-danger/20';
        resultDiv.innerHTML = `<span class="text-accent-danger">Erro de conexao: ${error.message}</span>`;
    }
}

async function loadNotionDatabases(apiKey) {
    const select = document.getElementById('notion-database-select');

    try {
        const response = await fetch(`/settings/notion/databases?api_key=${encodeURIComponent(apiKey)}`);
        const data = await response.json();

        select.innerHTML = '<option value="">Seleciona uma database...</option>';

        if (data.databases && data.databases.length > 0) {
            data.databases.forEach(db => {
                const option = document.createElement('option');
                option.value = db.id;
                option.textContent = db.title;
                select.appendChild(option);
            });
        } else {
            select.innerHTML = '<option value="">Nenhuma database encontrada - partilha uma database com a integracao</option>';
        }
    } catch (error) {
        console.error('Erro ao carregar databases:', error);
    }
}

async function connectNotion() {
    const databaseId = document.getElementById('notion-database-select').value;
    if (!databaseId) {
        alert('Seleciona uma database');
        return;
    }

    try {
        const response = await fetch('/settings/notion/connect', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `api_key=${encodeURIComponent(currentApiKey)}&database_id=${encodeURIComponent(databaseId)}`
        });

        if (response.ok) {
            window.location.reload();
        } else {
            const data = await response.json();
            alert('Erro: ' + (data.error || 'Falha ao conectar'));
        }
    } catch (error) {
        alert('Erro: ' + error.message);
    }
}
</script>
{% endblock %}
